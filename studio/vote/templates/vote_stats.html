<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="">
        <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="{{url_for('vote.static',filename='css/vote.css')}}" />
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
        <script src="https://cdn.jsdelivr.net/npm/echarts@5.0.0/dist/echarts.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->12312312
        <div class="col-md-6 col-sm-12 col-xs-12" id="timeline" style="min-height: 300px;">

        </div>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-lazyload@1.9.7/jquery.lazyload.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
        <script type="text/javascript">
            // based on prepared DOM, initialize echarts instance
            function getLocalTime(nS) {     
                return new Date(parseInt(nS) * 1000).toLocaleString().replace(/:\d{1,2}$/,' ');     
            }
            var myChart = echarts.init(document.getElementById('timeline'));
            myChart.showLoading();
            fetch('/vote/statistics/6').then(res => res.json()).then(res => {
                console.log(res)
                let legends = Object.keys(res)
                let data = {}
                for(let i=0;i<legends.length;i++){
                    data[legends[i]] = []
                    let now = 1607601600//1607601600//1607601600//12.10 20:00
                    let step = 900//15min
                    let end = 1607601600 + 48*3600//1608135600//1607659200//1608135600//12.16 24:00 
                    let max = 0
                    let timeArr = Object.keys(res[legends[i]])
                    //console.log(res[legends[i]])
                    //console.log(timeArr)
                    while(now<=end){
                        
                        if(parseInt(timeArr[0])>=now){//最新的时间比当前时间大，直接推0
                            data[legends[i]].push(max)
                            now = now + step
                            continue
                        } else {
                            let t=0;
                            while(parseInt(timeArr[t])<now && t!=timeArr.length-1){
                                t++;
                            }
                            max = res[legends[i]][timeArr[t]]
                            data[legends[i]].push(max) 
                            now = now + step
                            continue
                        } 
                    }
                    console.log(data[legends[i]])
                    //console.log('-------')
                    //break
                }
                let result = []
                Object.keys(data).map((v,i)=>{
                    result[i] = {
                        name:v,
                        type:'line',
                        data:data[v]
                    }
                })
                let ta = []
                for(let i=0;i<192;i++){
                    let ts = 1607601600 + i*900
                    ta.push(getLocalTime(ts))
                }
                //console.log('ta:',ta)
                //console.log('result:',result)
                let option = {
                    title: {
                        text: '排行榜--时间顺序'
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data: legends
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    toolbox: {
                        feature: {
                            saveAsImage: {}
                        }
                    },
                    xAxis: {
                        data: ta
                    },
                    yAxis: {
                        type: 'value',
                        name: '票数',
                        min:0,
                        max:300,
                        interval:15
                    },
                    series: result
                };
                // specify chart configuration item and data
                console.log(option.legend)
    
                // use configuration item and data specified to show chart
                myChart.setOption(option);
                myChart.hideLoading();
            })
            
        </script>
        <script src="" async defer></script>
    </body>
</html>